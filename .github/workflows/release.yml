name: Release

on:
  # Auto-release when PR is merged to main
  pull_request:
    types: [closed]
    branches: [main]
  # Manual trigger with optional version
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (leave empty for auto-increment)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    # Only run if PR was merged (not just closed) or manually triggered
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      kube_access: ${{ steps.setup_kube.outputs.KUBE_ACCESS }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Calculate version
        id: get_version
        run: |
          # Use provided version or auto-increment
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "Using provided version: $VERSION"
          else
            # Get the latest version tag
            LATEST_TAG=$(git tag -l '[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1)
            
            if [ -z "$LATEST_TAG" ]; then
              # No tags yet, start with 0.1.0
              LATEST_TAG="0.0.0"
            fi
            
            echo "Latest tag: $LATEST_TAG"
            
            # Parse version components and increment patch
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_TAG"
            PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${PATCH}"
            echo "Auto-incremented version: $VERSION"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
      
      - name: Create and push tag
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          
          # Check if tag already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, skipping tag creation"
          else
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            
            # Create annotated tag
            git tag -a "$VERSION" -m "Release $VERSION"
            git push origin "$VERSION"
            
            echo "‚úÖ Created and pushed tag: $VERSION"
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Chromium for PDF generation
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          echo "PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser" >> $GITHUB_ENV
      
      - name: Update version in cv.json (not committed)
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          DATE=$(date -u +%Y-%m-%d)
          echo "üìù Updating cv.json with version: $VERSION, date: $DATE"
          
          # Update version and touch fields in cv.json
          node -e "
            const fs = require('fs');
            const cv = JSON.parse(fs.readFileSync('cv.json', 'utf8'));
            cv.meta.version = '$VERSION';
            cv.meta.touch = '$DATE';
            fs.writeFileSync('cv.json', JSON.stringify(cv, null, 2) + '\n');
            console.log('‚úÖ cv.json updated');
          "
          
          # Rebuild resume files with updated version
          npm run build:all
          echo "‚úÖ Resume files rebuilt with version $VERSION"
      
      - name: Build PDFs
        run: |
          echo "Building PDFs..."
          npm run build:pdf || {
            echo "‚ùå PDF build failed!"
            exit 1
          }
          echo "‚úÖ PDFs built successfully!"
          ls -lh pdf/
          echo "Verifying PDF files exist:"
          if [ ! -f pdf/resume.eng.pdf ]; then
            echo "‚úó English PDF missing"
            exit 1
          fi
          echo "‚úì English PDF exists ($(du -h pdf/resume.eng.pdf | cut -f1))"
          if [ ! -f pdf/resume.rus.pdf ]; then
            echo "‚úó Russian PDF missing"
            exit 1
          fi
          echo "‚úì Russian PDF exists ($(du -h pdf/resume.rus.pdf | cut -f1))"
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          files: |
            pdf/resume.eng.pdf
            pdf/resume.rus.pdf
            out/*.json
          body: |
            Release ${{ steps.get_version.outputs.VERSION }}
            
            ## Resume Files
            - üìÑ English PDF: `resume.eng.pdf`
            - üìÑ Russian PDF: `resume.rus.pdf`
            - üìã English JSON: `eng.json`
            - üìã Russian JSON: `rus.json`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify PDFs before Docker build
        run: |
          echo "Checking PDF files before Docker build..."
          ls -lh pdf/
          echo "PDF files verified!"
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }}
            ghcr.io/${{ github.repository }}:latest
          # No cache to ensure fresh PDFs are included
          no-cache: true
      
      - name: Install Helm
        run: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      
      - name: Setup Kubernetes cluster access
        id: setup_kube
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          if [ -n "$KUBE_CONFIG" ]; then
            mkdir -p ~/.kube
            echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
            chmod 600 ~/.kube/config
            echo "KUBE_ACCESS=true" >> $GITHUB_OUTPUT
            echo "KUBE_ACCESS=true" >> $GITHUB_ENV
          else
            echo "KUBE_ACCESS=false" >> $GITHUB_OUTPUT
            echo "KUBE_ACCESS=false" >> $GITHUB_ENV
          fi
      
      - name: Deploy to Kubernetes with Helm
        if: env.KUBE_ACCESS == 'true'
        run: |
          helm upgrade --install cv ./helm/cv \
            --namespace cv \
            --create-namespace \
            --set image.tag="${{ steps.get_version.outputs.VERSION }}" \
            --wait \
            --timeout 3m \
            --debug
      
      - name: Create summary
        if: always()
        run: |
          echo "üéâ **Release ${{ steps.get_version.outputs.VERSION }} Complete!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Release Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY  
          echo "- **Git SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Completed Tasks" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Extracted version from tag" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Built PDF files for all languages" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Built and pushed Docker image" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Created GitHub Release with artifacts" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.KUBE_ACCESS }}" == "true" ]; then
            echo "- [x] Deployed to Kubernetes cluster successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [ ] Kubernetes deployment (cluster access not configured)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÑ Resume Files" >> $GITHUB_STEP_SUMMARY
          echo "- üìÑ English PDF: \`resume.eng.pdf\`" >> $GITHUB_STEP_SUMMARY
          echo "- üìÑ Russian PDF: \`resume.rus.pdf\`" >> $GITHUB_STEP_SUMMARY
          echo "- üìã English JSON: \`eng.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- üìã Russian JSON: \`rus.json\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üê≥ Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.KUBE_ACCESS }}" == "true" ]; then
            echo "### üöÄ Live Application" >> $GITHUB_STEP_SUMMARY
            echo "**CV version ${{ steps.get_version.outputs.VERSION }} is now live!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- üåê **English CV:** [https://cv.boysthings.top/](https://cv.boysthings.top/)" >> $GITHUB_STEP_SUMMARY
            echo "- üåê **Russian CV:** [https://cv.boysthings.top/rus](https://cv.boysthings.top/rus)" >> $GITHUB_STEP_SUMMARY
            echo "- üìÑ **PDF Files:** [https://cv.boysthings.top/pdf](https://cv.boysthings.top/pdf)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "Resume files have been uploaded to the [GitHub Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Kubernetes deployment was skipped (KUBE_CONFIG secret not configured)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Send Telegram Release Notification
        if: always()
        env:
          RELEASE_BOT_TOKEN: ${{ secrets.RELEASE_BOT_TOKEN }}
          RELEASE_CHANNEL: ${{ secrets.RELEASE_CHANNEL }}
        run: |
          if [ -n "$RELEASE_BOT_TOKEN" ] && [ -n "$RELEASE_CHANNEL" ]; then
            echo "üì± Sending Telegram release notification..."
            
            # Prepare deployment status message
            if [ "${{ env.KUBE_ACCESS }}" == "true" ]; then
              DEPLOY_STATUS="‚úÖ *Automatically deployed to Kubernetes*"
              APP_LINKS="
          üåê *Live Application:*
          ‚Ä¢ [English CV](https://cv.boysthings.top/)
          ‚Ä¢ [Russian CV](https://cv.boysthings.top/rus)
          ‚Ä¢ [PDF Files](https://cv.boysthings.top/pdf)"
            else
              DEPLOY_STATUS="üì¶ *Docker image published* (manual deployment required)"
              APP_LINKS=""
            fi
            
            # Create release message
            MESSAGE="üìÑ *CV Release ${{ steps.get_version.outputs.VERSION }}* üöÄ
            
          üè∑Ô∏è *Version:* ${{ steps.get_version.outputs.VERSION }}
          üìù *Commit:* [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ${DEPLOY_STATUS}${APP_LINKS}
          
          üê≥ *Docker Image:*
          \`ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }}\`
          
          üìã *Release Details:*
          [View on GitHub](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }})
          
          *Release pipeline completed successfully!* ‚ú®"
            
            # Send notification
            curl -s -X POST "https://api.telegram.org/bot${RELEASE_BOT_TOKEN}/sendMessage" \
              -d chat_id="${RELEASE_CHANNEL}" \
              -d parse_mode="Markdown" \
              -d text="$MESSAGE" \
              -d disable_web_page_preview="true"
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Telegram notification sent successfully!"
            else
              echo "‚ùå Failed to send Telegram notification"
            fi
          else
            echo "‚ö†Ô∏è Telegram secrets not configured - skipping notification"
          fi
